angular.module("ionic").factory("$jrCrop",["$ionicModal","$rootScope","$q",function(a,b,c){var d='<div class="jr-crop modal"><div class="jr-crop-center-container"><div class="jr-crop-img" ng-style="{width: width + \'px\', height: height + \'px\'}"></div></div><div class="jr-crop-center-container"><div class="jr-crop-select" style="overflow: hidden" ng-style="{width: width + \'px\', height: height + \'px\'}"></div></div><div class="bar bar-footer bar-dark jr-crop-footer"><button class="button button-clear" ng-click="cancel()">Cancel</button><div class="title">{{title}}</div><button class="button button-clear" ng-click="crop()">Choose</button></div></div>',e=ionic.views.View.inherit({promise:null,imgWidth:null,imgHeight:null,imgSelect:null,imgFull:null,posX:0,posY:0,scale:1,last_scale:1,last_posX:0,last_posY:0,initialize:function(a){var b=this;b.options=a,b.promise=c.defer(),b.loadImage().then(function(a){b.imgWidth=a.naturalWidth,b.imgHeight=a.naturalHeight,b.options.modal.el.querySelector(".jr-crop-img").appendChild(b.imgSelect=a.cloneNode()),b.options.modal.el.querySelector(".jr-crop-select").appendChild(b.imgFull=a.cloneNode()),b.bindHandlers(),b.initImage()}),b.options.cancel=this.cancel.bind(this),b.options.crop=this.crop.bind(this)},initImage:function(){var a=this;if(a.options.height<a.imgHeight||a.options.width<a.imgWidth){var b=a.imgWidth/a.imgHeight,c=a.options.width/a.options.height;a.scale=a.last_scale=c>b?a.options.width/a.imgWidth:a.options.height/a.imgHeight}var d=(a.imgWidth-a.options.width)/2,e=(a.imgHeight-a.options.height)/2;a.posX=a.last_posX=-d,a.posY=a.last_posY=-e,a.setImageTransform()},cancel:function(){var a=this;a.options.modal.remove().then(function(){a.promise.reject("canceled")})},bindHandlers:function(){function a(){b(),d.posX>e&&(d.posX=e),d.posX<g&&(d.posX=g),d.posY>f&&(d.posY=f),d.posY<h&&(d.posY=h)}function b(){var a=d.scale*d.imgWidth,b=d.scale*d.imgHeight;e=(a-d.imgWidth)/2,f=(b-d.imgHeight)/2,g=-(a-e-d.options.width),h=-(b-f-d.options.height)}var c,d=this,e=0,f=0,g=0,h=0,i=0,j=0,k=1,l=d.imgWidth/d.imgHeight,m=d.options.width/d.options.height;c=l>m?d.options.height/d.imgHeight:d.options.width/d.imgWidth,ionic.onGesture("touch transform drag dragstart dragend",function(b){switch(b.type){case"touch":d.last_scale=d.scale;break;case"drag":d.posX=d.last_posX+b.gesture.deltaX-i,d.posY=d.last_posY+b.gesture.deltaY-j,a();break;case"transform":d.scale=Math.max(c,Math.min(d.last_scale*b.gesture.scale,k)),a();break;case"dragend":d.last_posX=d.posX,d.last_posY=d.posY;break;case"dragstart":d.last_scale=d.scale,b.gesture.deltaX>1||b.gesture.deltaX<-1?(i=b.gesture.deltaX,j=b.gesture.deltaY):(i=0,j=0)}d.setImageTransform()},d.options.modal.el)},setImageTransform:function(){var a=this,b="translate3d("+a.posX+"px,"+a.posY+"px, 0) scale3d("+a.scale+","+a.scale+", 1)";a.imgSelect.style[ionic.CSS.TRANSFORM]=b,a.imgFull.style[ionic.CSS.TRANSFORM]=b},crop:function(){var a=document.createElement("canvas"),b=a.getContext("2d");a.width=this.options.width/this.scale,a.height=this.options.height/this.scale;var c=this.imgWidth*this.scale,d=this.imgHeight*this.scale,e=(c-this.imgWidth)/2,f=(d-this.imgHeight)/2,g=(this.posX-e)/this.scale,h=(this.posY-f)/this.scale;b.drawImage(this.imgFull,g,h),this.options.modal.remove(),this.promise.resolve(a)},loadImage:function(){var a=c.defer();return angular.element("<img />").bind("load",function(){a.resolve(this)}).bind("error",a.reject).prop("src",this.options.url),a.promise}});return{options:{width:0,height:0,aspectRatio:0},crop:function(c){this.initOptions(c);var f=b.$new(!0);return ionic.Utils.extend(f,this.options),f.modal=a.fromTemplate(d,{scope:f}),f.modal.show().then(function(){return new e(f).promise.promise})},initOptions:function(a){ionic.Utils.extend(this.options,a),this.options.aspectRatio&&(!this.options.width&&this.options.height&&(this.options.width=200),this.options.width?this.options.height=this.options.width/this.options.aspectRatio:this.options.height&&(this.options.width=this.options.height*this.options.aspectRatio))}}}]);