angular.module("ionic").factory("$jrCrop",["$ionicModal","$rootScope","$q",function(a,b,c){var d='<div class="jr-crop modal"><div class="jr-crop-center-container"><div class="jr-crop-img" ng-style="{width: width + \'px\', height: height + \'px\'}"></div></div><div class="jr-crop-center-container"><div class="jr-crop-select" style="overflow: hidden" ng-style="{width: width + \'px\', height: height + \'px\'}"></div></div><div class="bar bar-footer bar-dark jr-crop-footer"><button class="button button-clear" ng-click="cancel()">Cancel</button><div class="title">{{title}}</div><button class="button button-clear" ng-click="crop()">Choose</button></div></div>',e=ionic.views.View.inherit({promise:null,imgWidth:null,imgHeight:null,imgSelect:null,imgFull:null,posX:0,posY:0,scale:1,initialize:function(a){var b=this;this.options=a,this.promise=c.defer(),this.loadImage().then(function(a){b.imgWidth=a.naturalWidth,b.imgHeight=a.naturalHeight,b.options.modal.el.querySelector(".jr-crop-img").appendChild(b.imgSelect=a.cloneNode()),b.options.modal.el.querySelector(".jr-crop-select").appendChild(b.imgFull=a.cloneNode()),b.bindHandlers()}),this.options.cancel=this.cancel.bind(this),this.options.crop=this.crop.bind(this)},cancel:function(){var a=this;this.options.modal.remove().then(function(){a.promise.reject("canceled")})},bindHandlers:function(){function a(){b(),e.posX>h&&(e.posX=h),e.posX<j&&(e.posX=j),e.posY>i&&(e.posY=i),e.posY<k&&(e.posY=k)}function b(){var a=e.scale*e.imgWidth,b=e.scale*e.imgHeight;h=(a-e.imgWidth)/2,i=(b-e.imgHeight)/2,j=-(a-h-e.options.width),k=-(b-i-e.options.height)}var c,d,e=this,f=0,g=0,h=0,i=0,j=0,k=0,l=0,m=0,n=e.imgWidth/e.imgHeight,o=e.options.width/e.options.height;d=n>o?e.options.height/e.imgHeight:e.options.width/e.imgWidth,ionic.onGesture("touch transform drag dragstart dragend",function(b){switch(b.type){case"touch":c=e.scale;break;case"drag":e.posX=f+b.gesture.deltaX-l,e.posY=g+b.gesture.deltaY-m,a();break;case"transform":e.scale=Math.max(d,Math.min(c*b.gesture.scale,10)),a();break;case"dragend":f=e.posX,g=e.posY;break;case"dragstart":c=e.scale,b.gesture.deltaX>1||b.gesture.deltaX<-1?(l=b.gesture.deltaX,m=b.gesture.deltaY):(l=0,m=0)}var h="translate3d("+e.posX+"px,"+e.posY+"px, 0) scale3d("+e.scale+","+e.scale+", 0)";e.imgSelect.style[ionic.CSS.TRANSFORM]=h,e.imgFull.style[ionic.CSS.TRANSFORM]=h},e.options.modal.el)},crop:function(){var a=document.createElement("canvas"),b=a.getContext("2d");a.width=this.options.width/this.scale,a.height=this.options.height/this.scale;var c=this.imgWidth*this.scale,d=this.imgHeight*this.scale,e=(c-this.imgWidth)/2,f=(d-this.imgHeight)/2,g=(this.posX-e)/this.scale,h=(this.posY-f)/this.scale;b.drawImage(this.imgFull,g,h),this.options.modal.remove(),this.promise.resolve(a)},loadImage:function(){var a=c.defer();return angular.element("<img />").bind("load",function(){a.resolve(this)}).bind("error",a.reject).prop("src",this.options.url),a.promise}});return{crop:function(c){var f=b.$new(!0);return ionic.Utils.extend(f,c),f.modal=a.fromTemplate(d,{scope:f}),f.modal.show().then(function(){return new e(f).promise.promise})}}}]);