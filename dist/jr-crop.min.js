/**
 * jr-crop - A simple ionic plugin to crop your images.
 * @version v0.1.0
 * @link https://github.com/JrSchild/jr-crop
 * @author Joram Ruitenschild
 * @license MIT
 */
angular.module("ionic").factory("$jrCrop",["$ionicModal","$rootScope","$q",function(t,i,s){var o='<div class="jr-crop modal"><div class="jr-crop-center-container"><div class="jr-crop-img" ng-style="{width: width + \'px\', height: height + \'px\'}"></div></div><div class="jr-crop-center-container"><div class="jr-crop-select" style="overflow: hidden" ng-style="{width: width + \'px\', height: height + \'px\'}"></div></div><div class="bar bar-footer bar-dark jr-crop-footer"><button class="button button-clear" ng-click="cancel()">Cancel</button><div class="title">{{title}}</div><button class="button button-clear" ng-click="crop()">Choose</button></div></div>',e=ionic.views.View.inherit({promise:null,imgWidth:null,imgHeight:null,imgSelect:null,imgFull:null,posX:0,posY:0,scale:1,last_scale:1,last_posX:0,last_posY:0,initialize:function(t){var i=this;i.options=t,i.promise=s.defer(),i.loadImage().then(function(t){i.imgWidth=t.naturalWidth,i.imgHeight=t.naturalHeight,i.options.modal.el.querySelector(".jr-crop-img").appendChild(i.imgSelect=t.cloneNode()),i.options.modal.el.querySelector(".jr-crop-select").appendChild(i.imgFull=t.cloneNode()),i.bindHandlers(),i.initImage()}),i.options.cancel=this.cancel.bind(this),i.options.crop=this.crop.bind(this)},initImage:function(){var t=this;if(t.options.height<t.imgHeight||t.options.width<t.imgWidth){var i=t.imgWidth/t.imgHeight,s=t.options.width/t.options.height;t.scale=t.last_scale=s>i?t.options.width/t.imgWidth:t.options.height/t.imgHeight}var o=(t.imgWidth-t.options.width)/2,e=(t.imgHeight-t.options.height)/2;t.posX=t.last_posX=-o,t.posY=t.last_posY=-e,t.setImageTransform()},cancel:function(){var t=this;t.options.modal.remove().then(function(){t.promise.reject("canceled")})},bindHandlers:function(){function t(){i(),o.posX>e&&(o.posX=e),o.posX<a&&(o.posX=a),o.posY>n&&(o.posY=n),o.posY<h&&(o.posY=h)}function i(){var t=o.scale*o.imgWidth,i=o.scale*o.imgHeight;e=(t-o.imgWidth)/2,n=(i-o.imgHeight)/2,a=-(t-e-o.options.width),h=-(i-n-o.options.height)}var s,o=this,e=0,n=0,a=0,h=0,l=0,r=0,c=1,p=o.imgWidth/o.imgHeight,d=o.options.width/o.options.height;s=p>d?o.options.height/o.imgHeight:o.options.width/o.imgWidth,ionic.onGesture("touch transform drag dragstart dragend",function(i){switch(i.type){case"touch":o.last_scale=o.scale;break;case"drag":o.posX=o.last_posX+i.gesture.deltaX-l,o.posY=o.last_posY+i.gesture.deltaY-r,t();break;case"transform":o.scale=Math.max(s,Math.min(o.last_scale*i.gesture.scale,c)),t();break;case"dragend":o.last_posX=o.posX,o.last_posY=o.posY;break;case"dragstart":o.last_scale=o.scale,i.gesture.deltaX>1||i.gesture.deltaX<-1?(l=i.gesture.deltaX,r=i.gesture.deltaY):(l=0,r=0)}o.setImageTransform()},o.options.modal.el)},setImageTransform:function(){var t=this,i="translate3d("+t.posX+"px,"+t.posY+"px, 0) scale3d("+t.scale+","+t.scale+", 1)";t.imgSelect.style[ionic.CSS.TRANSFORM]=i,t.imgFull.style[ionic.CSS.TRANSFORM]=i},crop:function(){var t=document.createElement("canvas"),i=t.getContext("2d");t.width=this.options.width/this.scale,t.height=this.options.height/this.scale;var s=this.imgWidth*this.scale,o=this.imgHeight*this.scale,e=(s-this.imgWidth)/2,n=(o-this.imgHeight)/2,a=(this.posX-e)/this.scale,h=(this.posY-n)/this.scale;i.drawImage(this.imgFull,a,h),this.options.modal.remove(),this.promise.resolve(t)},loadImage:function(){var t=s.defer();return angular.element("<img />").bind("load",function(){t.resolve(this)}).bind("error",t.reject).prop("src",this.options.url),t.promise}});return{options:{width:0,height:0,aspectRatio:0},crop:function(s){this.initOptions(s);var n=i.$new(!0);return ionic.Utils.extend(n,this.options),n.modal=t.fromTemplate(o,{scope:n}),n.modal.show().then(function(){return new e(n).promise.promise})},initOptions:function(t){ionic.Utils.extend(this.options,t),this.options.aspectRatio&&(!this.options.width&&this.options.height&&(this.options.width=200),this.options.width?this.options.height=this.options.width/this.options.aspectRatio:this.options.height&&(this.options.width=this.options.height*this.options.aspectRatio))}}}]);